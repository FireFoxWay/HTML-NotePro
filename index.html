<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Clock + Dock</title>

  <style>
    :root{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);
      --panel: rgba(18,20,35,.70);
      --border: rgba(255,255,255,.12);
      --shadow: 0 18px 70px rgba(0,0,0,.70);
    }

    html,body{height:100%;margin:0}
    body{
      background:
        radial-gradient(1200px 600px at 20% 10%, #0e1a3a, transparent 60%),
        radial-gradient(900px 500px at 80% 90%, #101f4a, transparent 55%),
        linear-gradient(180deg, #050512, #070b1a);
      color: var(--text);
      overflow:hidden;
    }

    /* VIEWS */
    .view{
      position:fixed;
      inset:0;
      display:none;
      padding: 22px 16px 92px; /* bottom room for dock */
      overflow:auto;
    }
    .view.active{display:block}

    /* HOME CLOCK */
    .homeCenter{
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      user-select:none;
    }
    .time{
      font-size: clamp(56px, 10vw, 110px);
      font-weight: 900;
      letter-spacing: 1px;
      line-height: 1;
      text-shadow: 0 18px 70px rgba(0,0,0,.6);
    }
    .sub{
      margin-top: 14px;
      font-size: clamp(14px, 2.5vw, 20px);
      color: var(--muted);
      letter-spacing: .2px;
    }

    /* WINDOW CONTENT */
    .window{
      max-width: 980px;
      margin: 0 auto;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      padding: 16px;
    }
    .windowHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:12px;
    }
    .windowHead h2{margin:0;font-size:18px}
    .mini{font-size:12px;color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .spacer{flex:1}
    hr{border:none;border-top:1px solid rgba(255,255,255,.10);margin:12px 0}

    input, select, textarea, button{
      font: inherit;
    }
    input, select, textarea{
      background: rgba(0,0,0,.30);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 12px;
      padding: 10px 12px;
      color: var(--text);
      outline: none;
    }
    textarea{width:100%;resize:none}
    input:focus, select:focus, textarea:focus{
      border-color: rgba(139,92,246,.55);
      box-shadow: 0 0 0 4px rgba(139,92,246,.12);
    }
    button{
      cursor:pointer;
      border-radius: 12px;
      padding: 10px 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.08);
      color: var(--text);
      transition: transform .12s ease, filter .12s ease;
    }
    button:hover{filter: brightness(1.12)}
    button:active{transform: translateY(1px)}
    .btnGreen{background: rgba(34,197,94,.18)}
    .btnRed{background: rgba(239,68,68,.16)}
    .btnPurple{background: rgba(139,92,246,.18)}

    /* LIST CARDS */
    .list{display:flex;flex-direction:column;gap:10px}
    .card{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 12px;
      position: relative;
    }
    .cardTitle{font-weight:800}
    .cardMeta{margin-top:4px;font-size:12px;color:var(--muted)}
    .cardActions{
      position:absolute; top:10px; right:10px;
      display:flex; gap:8px;
    }
    .smallBtn{padding:7px 9px;border-radius:10px;font-size:12px}

    /* DOCK */
    .dock{
      position:fixed;
      left:50%;
      bottom:14px;
      transform:translateX(-50%);
      z-index:9999;
      display:flex;
      gap:10px;
      padding:10px 12px;
      border-radius:22px;
      background: rgba(18,20,35,.55);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      user-select:none;
    }
    .dockItem{position:relative}
    .dockBtn{
      width:52px;height:52px;
      border-radius:16px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--text);
      font-size:20px;
      transition: transform .16s ease, filter .16s ease, background .16s ease;
      padding:0;
    }
    .dockBtn:hover{
      transform: translateY(-6px) scale(1.10);
      filter: brightness(1.15);
      background: rgba(255,255,255,.10);
    }
    .dockTip{
      position:absolute;
      bottom:62px;
      left:50%;
      transform:translateX(-50%);
      font-size:11px;
      padding:6px 8px;
      border-radius:10px;
      background: rgba(0,0,0,.55);
      border: 1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.85);
      white-space:nowrap;
      opacity:0;
      pointer-events:none;
      transition: opacity .15s ease;
    }
    .dockItem:hover .dockTip{opacity:1}

    /* CHAT LOG */
    .chatLog{
      height: 320px;
      overflow:auto;
      padding: 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.30);
      border: 1px solid rgba(255,255,255,.10);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 13px;
      line-height: 1.45;
    }

    /* MODAL PREVIEW */
    .modal{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      padding:16px;
      z-index: 99999;
    }
    .modal.show{display:flex}
    .modalCard{
      width:min(980px, 100%);
      background: rgba(18,20,35,.92);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      box-shadow: 0 22px 90px rgba(0,0,0,.75);
      padding: 14px;
    }
  </style>
</head>

<body>

  <!-- HOME (Clock-only + Dock) -->
  <section class="view active" id="home">
    <div class="homeCenter">
      <div>
        <div class="time" id="t">--:--</div>
        <div class="sub" id="d">‚Äî</div>
      </div>
    </div>
  </section>

  <!-- CHAT WINDOW -->
  <section class="view" id="chat">
    <div class="window">
      <div class="windowHead">
        <h2>Chat</h2>
        <div class="mini" id="chatStatus">Not connected</div>
      </div>

      <div class="row">
        <input id="chatName" placeholder="Your name (e.g., Umesh)" />
        <input id="chatRoom" placeholder="Room code (e.g., memoria)" />
        <button class="btnGreen" id="chatConnect">Connect</button>
      </div>

      <div class="mini" style="margin-top:8px">
        Share the same <b>Room code</b> with your friend. Both must open this website.
      </div>

      <hr>

      <div class="chatLog" id="chatLog"></div>

      <div class="row" style="margin-top:12px">
        <input id="chatMsg" style="flex:1" placeholder="Type a message..." />
        <button class="btnPurple" id="chatSend">Send</button>
      </div>
    </div>
  </section>

  <!-- VAULT WINDOW -->
  <section class="view" id="vault">
    <div class="window">
      <div class="windowHead">
        <h2>File Vault</h2>
        <div class="mini">Saved in your browser (IndexedDB)</div>
      </div>

      <div class="row">
        <input id="fileTitle" placeholder="Title (optional)" style="flex:1" />
        <select id="fileTag">
          <option>General</option>
          <option>School</option>
          <option>Media</option>
          <option>Projects</option>
        </select>
      </div>

      <div class="row" style="margin-top:10px">
        <input id="filePick" type="file" />
        <button class="btnGreen" id="btnSaveFile">Save</button>
        <button class="btnRed" id="btnClearVault">Clear Vault</button>
      </div>

      <div class="mini" style="margin-top:10px">
        Preview: PDF / MP3 / MP4. Word/PPT will be download-only.
      </div>

      <hr>

      <div class="list" id="vaultList"></div>
    </div>
  </section>

  <!-- DOCK (always visible) -->
  <nav class="dock" aria-label="Dock">
    <div class="dockItem">
      <div class="dockTip">Home</div>
      <button class="dockBtn" data-go="home" aria-label="Home">üè†</button>
    </div>
    <div class="dockItem">
      <div class="dockTip">Chat</div>
      <button class="dockBtn" data-go="chat" aria-label="Chat">üí¨</button>
    </div>
    <div class="dockItem">
      <div class="dockTip">Vault</div>
      <button class="dockBtn" data-go="vault" aria-label="Vault">üóÇÔ∏è</button>
    </div>
  </nav>

  <!-- PREVIEW MODAL -->
  <div class="modal" id="modal">
    <div class="modalCard">
      <div class="windowHead" style="margin-bottom:10px">
        <h2 id="modalTitle" style="font-size:16px">Preview</h2>
        <div class="spacer"></div>
        <button id="modalClose">Close</button>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>

  <script>
    /* ===== CLOCK ===== */
    function updateClock(){
      const now = new Date();
      document.getElementById("t").textContent =
        now.toLocaleTimeString([], { hour:"2-digit", minute:"2-digit" });

      const day  = now.toLocaleDateString([], { weekday:"long" });
      const date = now.toLocaleDateString([], { year:"numeric", month:"long", day:"numeric" });
      document.getElementById("d").textContent = `${day} ‚Ä¢ ${date}`;
    }
    updateClock();
    setInterval(updateClock, 1000);

    /* ===== VIEW SWITCH + BACK BUTTON ===== */
    const views = ["home","chat","vault"];
    function showView(id, push=true){
      if(!views.includes(id)) id="home";
      for(const v of views){
        document.getElementById(v).classList.toggle("active", v===id);
      }
      if(push) history.pushState({view:id}, "", "#"+id);
    }

    document.querySelectorAll("[data-go]").forEach(btn=>{
      btn.addEventListener("click", ()=>showView(btn.dataset.go, true));
    });

    window.addEventListener("popstate", (e)=>{
      const id = (e.state && e.state.view) ? e.state.view : (location.hash.replace("#","") || "home");
      showView(id, false);
    });

    const start = location.hash.replace("#","") || "home";
    history.replaceState({view:start}, "", "#"+start);
    showView(start, false);

    /* ===== VAULT (IndexedDB) ===== */
    const vaultList = document.getElementById("vaultList");
    const modal = document.getElementById("modal");
    const modalTitle = document.getElementById("modalTitle");
    const modalBody = document.getElementById("modalBody");
    const modalClose = document.getElementById("modalClose");

    let previewUrl = null;

    function bytesToSize(bytes){
      if(bytes===0) return "0 B";
      const k=1024, sizes=["B","KB","MB","GB"];
      const i=Math.floor(Math.log(bytes)/Math.log(k));
      return `${(bytes/Math.pow(k,i)).toFixed(i?2:0)} ${sizes[i]}`;
    }

    const IDB = (() => {
      const DBNAME="clockdock_vault_v1";
      const VERSION=1;
      let db=null;

      function open(){
        if(db) return Promise.resolve(db);
        return new Promise((resolve,reject)=>{
          const req = indexedDB.open(DBNAME, VERSION);
          req.onupgradeneeded = () => {
            const d = req.result;
            if(!d.objectStoreNames.contains("files")){
              d.createObjectStore("files", { keyPath:"id" });
            }
          };
          req.onsuccess = () => { db=req.result; resolve(db); };
          req.onerror = () => reject(req.error);
        });
      }

      async function put(val){
        const d = await open();
        return new Promise((res,rej)=>{
          const tx = d.transaction("files","readwrite");
          tx.objectStore("files").put(val);
          tx.oncomplete = ()=>res(true);
          tx.onerror = ()=>rej(tx.error);
        });
      }

      async function getAll(){
        const d = await open();
        return new Promise((res,rej)=>{
          const tx = d.transaction("files","readonly");
          const r = tx.objectStore("files").getAll();
          r.onsuccess = ()=>res(r.result || []);
          r.onerror = ()=>rej(r.error);
        });
      }

      async function get(id){
        const d = await open();
        return new Promise((res,rej)=>{
          const tx = d.transaction("files","readonly");
          const r = tx.objectStore("files").get(id);
          r.onsuccess = ()=>res(r.result || null);
          r.onerror = ()=>rej(r.error);
        });
      }

      async function del(id){
        const d = await open();
        return new Promise((res,rej)=>{
          const tx = d.transaction("files","readwrite");
          tx.objectStore("files").delete(id);
          tx.oncomplete = ()=>res(true);
          tx.onerror = ()=>rej(tx.error);
        });
      }

      async function clear(){
        const d = await open();
        return new Promise((res,rej)=>{
          const tx = d.transaction("files","readwrite");
          tx.objectStore("files").clear();
          tx.oncomplete = ()=>res(true);
          tx.onerror = ()=>rej(tx.error);
        });
      }

      return { put,getAll,get,del,clear };
    })();

    let vaultFiles = [];

    function esc(s){
      return String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
    }

    async function loadVault(){
      vaultFiles = await IDB.getAll();
      vaultFiles.sort((a,b)=> (b.savedAt||0) - (a.savedAt||0));
      renderVault();
    }

    function renderVault(){
      if(!vaultFiles.length){
        vaultList.innerHTML = `<div class="mini">No files saved yet.</div>`;
        return;
      }

      vaultList.innerHTML = vaultFiles.map(f=>{
        const when = new Date(f.savedAt||Date.now()).toLocaleString();
        const size = bytesToSize(f.size||0);
        const title = f.title || f.name || "Untitled";
        const tag = f.tag || "General";
        return `
          <div class="card" data-id="${esc(f.id)}">
            <div class="cardActions">
              <button class="smallBtn btnPurple" data-act="preview">Preview</button>
              <button class="smallBtn" data-act="download">Download</button>
              <button class="smallBtn btnRed" data-act="delete">Delete</button>
            </div>
            <div class="cardTitle">${esc(title)}</div>
            <div class="cardMeta">üìÅ ${esc(tag)} ‚Ä¢ ${esc(when)} ‚Ä¢ ${esc(size)} ‚Ä¢ ${esc(f.name || "")}</div>
          </div>
        `;
      }).join("");
    }

    async function saveFile(){
      const file = document.getElementById("filePick").files?.[0];
      if(!file){ alert("Choose a file first"); return; }

      const title = (document.getElementById("fileTitle").value||"").trim();
      const tag = document.getElementById("fileTag").value || "General";

      const rec = {
        id: crypto.randomUUID(),
        name: file.name,
        type: file.type || "application/octet-stream",
        size: file.size,
        title,
        tag,
        savedAt: Date.now(),
        blob: file
      };

      try{
        await IDB.put(rec);
        document.getElementById("filePick").value="";
        document.getElementById("fileTitle").value="";
        await loadVault();
        alert("Saved to vault ‚úÖ");
      }catch(e){
        alert("Save failed (storage limit?)");
      }
    }

    async function downloadFile(id){
      const rec = await IDB.get(id);
      if(!rec?.blob){ alert("File not found"); return; }
      const url = URL.createObjectURL(rec.blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = rec.name || "download";
      a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 1200);
    }

    function showModal(title, html){
      modalTitle.textContent = title;
      modalBody.innerHTML = html;
      modal.classList.add("show");
    }

    function closeModal(){
      if(previewUrl){
        try{ URL.revokeObjectURL(previewUrl); }catch{}
        previewUrl = null;
      }
      modal.classList.remove("show");
      modalBody.innerHTML = "";
    }

    async function previewFile(id){
      const rec = await IDB.get(id);
      if(!rec?.blob){ alert("File not found"); return; }

      const name = rec.name || "Preview";
      const type = rec.type || "";
      const url = URL.createObjectURL(rec.blob);
      previewUrl = url;

      const lower = name.toLowerCase();
      if(type === "application/pdf" || lower.endsWith(".pdf")){
        showModal(name, `<iframe src="${url}" style="width:100%;height:70vh;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:#000"></iframe>`);
        return;
      }
      if(type.startsWith("audio") || lower.endsWith(".mp3")){
        showModal(name, `<audio controls style="width:100%"><source src="${url}" type="${type || "audio/mpeg"}"></audio>`);
        return;
      }
      if(type.startsWith("video") || lower.endsWith(".mp4")){
        showModal(name, `<video controls style="width:100%;max-height:70vh;border-radius:14px;border:1px solid rgba(255,255,255,.12)"><source src="${url}" type="${type || "video/mp4"}"></video>`);
        return;
      }

      showModal(name, `<div class="mini">Preview not supported here. Use Download.</div>`);
    }

    async function deleteFile(id){
      await IDB.del(id);
      await loadVault();
    }

    async function clearVault(){
      if(!confirm("Clear ALL vault files?")) return;
      await IDB.clear();
      await loadVault();
    }

    document.getElementById("btnSaveFile").addEventListener("click", saveFile);
    document.getElementById("btnClearVault").addEventListener("click", clearVault);

    vaultList.addEventListener("click", async (e)=>{
      const btn = e.target.closest("button[data-act]");
      if(!btn) return;
      const card = e.target.closest(".card");
      if(!card) return;
      const id = card.getAttribute("data-id");
      const act = btn.getAttribute("data-act");

      if(act==="preview") await previewFile(id);
      if(act==="download") await downloadFile(id);
      if(act==="delete") await deleteFile(id);
    });

    modalClose.addEventListener("click", closeModal);
    modal.addEventListener("click", (e)=>{ if(e.target === modal) closeModal(); });

    loadVault();
  </script>

  <!-- ===== FIREBASE CHAT (Firestore) ===== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getFirestore, collection, addDoc, serverTimestamp,
      query, orderBy, limit, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // ‚úÖ Your config (already yours)
    const firebaseConfig = {
      apiKey: "AIzaSyB7AhWd_9tt33c2mvGBMMaFFzBFjxk8svc",
      authDomain: "notepro-3194d.firebaseapp.com",
      projectId: "notepro-3194d",
      storageBucket: "notepro-3194d.firebasestorage.app",
      messagingSenderId: "748657045336",
      appId: "1:748657045336:web:1a10be8e3aec289933ff2d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const chatStatus  = document.getElementById("chatStatus");
    const chatLog     = document.getElementById("chatLog");
    const chatName    = document.getElementById("chatName");
    const chatRoom    = document.getElementById("chatRoom");
    const chatConnect = document.getElementById("chatConnect");
    const chatMsg     = document.getElementById("chatMsg");
    const chatSend    = document.getElementById("chatSend");

    let unsub = null;
    let connectedRoom = null;

    function safeText(s){ return (s ?? "").toString().slice(0, 500); }
    function showStatus(t){ chatStatus.textContent = t; }
    function clearChat(){ chatLog.innerHTML = ""; }
    function esc(s){
      return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
    }
    function addLine(html){
      const div = document.createElement("div");
      div.innerHTML = html;
      chatLog.appendChild(div);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    // Restore saved
    try{
      const n = localStorage.getItem("cd_chat_name");
      const r = localStorage.getItem("cd_chat_room");
      if(n) chatName.value = n;
      if(r) chatRoom.value = r;
    }catch{}

    chatConnect.addEventListener("click", ()=>{
      const name = safeText(chatName.value.trim()) || "Anonymous";
      const room = safeText(chatRoom.value.trim()).replace(/\s+/g,"-").toLowerCase();
      if(!room){ showStatus("Enter a room code first."); return; }

      // save
      try{
        localStorage.setItem("cd_chat_name", name);
        localStorage.setItem("cd_chat_room", room);
      }catch{}

      if(unsub){ unsub(); unsub=null; }
      connectedRoom = room;
      clearChat();
      showStatus(`Connected: ${room}`);

      const msgsRef = collection(db, "rooms", room, "messages");
      const q = query(msgsRef, orderBy("createdAt","asc"), limit(250));

      unsub = onSnapshot(q, (snap)=>{
        clearChat();
        snap.forEach(doc=>{
          const m = doc.data() || {};
          const who  = safeText(m.name || "Anon");
          const text = safeText(m.text || "");
          const time = m.createdAt?.toDate
            ? m.createdAt.toDate().toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"})
            : "--:--";
          addLine(`<span style="color:rgba(255,255,255,.65)">[${esc(time)}]</span> <b>${esc(who)}:</b> ${esc(text)}`);
        });
      }, (err)=>{
        showStatus("Chat error: " + err.message);
      });
    });

    async function send(){
      const name = safeText(chatName.value.trim()) || "Anonymous";
      const text = safeText(chatMsg.value.trim());
      if(!connectedRoom){ showStatus("Connect to a room first."); return; }
      if(!text) return;

      chatMsg.value = "";
      try{
        const msgsRef = collection(db, "rooms", connectedRoom, "messages");
        await addDoc(msgsRef, { name, text, createdAt: serverTimestamp() });
      }catch(e){
        showStatus("Send failed: " + e.message);
      }
    }

    chatSend.addEventListener("click", send);
    chatMsg.addEventListener("keydown", (e)=>{ if(e.key==="Enter") send(); });
  </script>

</body>
</html>
